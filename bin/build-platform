#!/usr/bin/env bash

# Build and tag images
function build_image() {
    local docker_dir="docker/${1}"
    local docker_file="${docker_dir}/Dockerfile"
    local component_name="ap-${2}"
    local build_opts="--build-arg BUILD_NUMBER=${BUILD_NUMBER} ${3}"
    local version="${ASTRONOMER_VERSION}"

    # Build component
    if [ -f "${docker_file}" ]; then
        docker build ${build_opts} -t "${REPOSITORY}/${component_name}:${version}" -f "${docker_file}" "${docker_dir}" || exit 1
    fi
}

# Build platform images
for component in ${PLATFORM_COMPONENTS} ; do
    # If we're building an RC, build platform components from master
    if [ "${ASTRONOMER_USE_MASTER}" = true ]; then
        build_opts="--build-arg VERSION=master --label io.astronomer.docker.master=true"
    fi
    build_image "platform/${component}" "${component}" "${build_opts}"
done

# Build vendor images
for component in ${VENDOR_COMPONENTS} ; do
    build_image "vendor/${component}" "${component}"
done
